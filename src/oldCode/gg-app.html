<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="./../bower_components/paper-input/paper-input.html">
<link rel="import" href="./../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="./../bower_components/paper-card/paper-card.html">
<!--<link rel="import" href="">-->
<link rel="import" href="./../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="./../bower_components/geo-location/geo-location.html">
<link rel="import" href="gg-icons.html">
<link rel="lazy-import" href="gg-home.html">
<link rel="lazy-import" href="gg-mvp.html">
<!--<link rel="lazy-import" href="gg-dating.html">-->
<link rel="lazy-import" href="gg-404.html">
<dom-module id="gg-app">
    <template>
        <style>
             :host {
                --app-primary-color: #4285f4;
                --app-secondary-color: black;
                display: block;
            }
            app-drawer-layout:not([narrow]) [drawer-toggle] {
                display: none;
            }
            app-header {
                color: #fff;
                background-color: var(--app-primary-color);
            }
            app-header paper-icon-button {
                --paper-icon-button-ink-color: white;
            }
            .drawer-list {
                margin: 0 20px;
            }
            .drawer-list a {
                display: block;
                padding: 0 16px;
                text-decoration: none;
                color: var(--app-secondary-color);
                line-height: 40px;
            }
            .drawer-list a.iron-selected {
                color: black;
                font-weight: bold;
            }
        </style>
        <firebase-app auth-domain="earthgrid-cc4e4.firebaseio.com" database-url="https://earthgrid-cc4e4.firebaseio.com/" api-key="AIzaSyBYNdyJJn3o45wNO-PTgoV4FG0gxjZntfI"></firebase-app>
        <firebase-auth id="auth" user="{{user}}" provider="google" signed-in="{{loggedIn}}" status-known="{{userStatus}}" on-error="handleError"></firebase-auth>
        <firebase-document path="/settings" data="{{settings}}"></firebase-document>
        <firebase-document path="/locations" data="{{allIds}}"></firebase-document>
        <firebase-document path="/locations/[[id]]/[[uid]]" data="{{userData}}"></firebase-document>
        <geo-location watch-pos high-accuracy latitude="{{lat}}" longitude="{{lng}}"></geo-location>
        <app-location route="{{route}}"></app-location>
        <app-route route="{{route}}" pattern="[[rootPattern]]:page" data="{{routeData}}" tail="{{subroute}}"></app-route>
        <app-drawer-layout fullbleed responsive-width="2000px">
            <!-- Drawer content -->
            <app-drawer id="drawer" slot="drawer">
                <app-toolbar>Navigation</app-toolbar>
                <iron-selector selected="[[page]]" attr-for-selected="name" class="drawer-list" role="navigation">
                    <a name="home" href="home">Home</a>
                    <a name="mvp" href="mvp">MVP</a>
                    <a name="dating" href="dating">Dating</a>
                </iron-selector>
            </app-drawer>
            <!-- Main content -->
            <app-header-layout has-scrolling-region>
                <app-header slot="header" condenses reveals effects="waterfall">
                    <app-toolbar>
                        <paper-icon-button icon="gg-icons:menu" drawer-toggle></paper-icon-button>
                        <div main-title>GG Demo</div>
                    </app-toolbar>
                </app-header>
                <iron-pages selected="[[page]]" attr-for-selected="name" fallback-selection="404" role="main">
                    <gg-home name="home"></gg-home>
                    <gg-mvp name="mvp" la="[[lat]]" lg="[[lng]]" id="[[sectorId]]" status="[[userStatus]]" lh="[[locationHistory]]" max="{{maxTolerableDistanceInKm}}" inc="{{increment}}" idle="{{idleTime}}"></gg-mvp>
                    <gg-dating name="dating"></gg-dating>
                    <gg-404 name="404"></gg-404>
                </iron-pages>
                <paper-textarea label="Location" value="[[parseJson(locationHistory)]]" readonly></paper-textarea>
            </app-header-layout>
        </app-drawer-layout>
    </template>
    <script>
        class GGApp extends Polymer.Element {
            static get is() { return 'gg-app'; }
            static get properties() {
                return {
                    page: {
                        type: String,
                        reflectToAttribute: true,
                        observer: '_pageChanged'
                    }, lat: {
                        type: String,
                        notify: true,
                        observer: '_handleNewData'
                    }, lng: {
                        type: String,
                        notify: true,
                        observer: '_handleNewData'
                    }, idleTime: {
                        type: Number,
                        notify: true,
                        value: 1,
                        observer: '_handleNewData'
                    }, increment: {
                        type: Number,
                        notify: true,
                        value: 0.001,
                        observer: '_handleNewData'
                    }, maxTolerableDistanceInKm: {
                        type: Number,
                        notify: true,
                        value: 0.02,
                        observer: '_handleNewData'
                    }, sectorId: {
                        type: String,
                        notify: true,
                        value: ""
                    }, idleForXMins: {
                        type: Boolean,
                        notify: true,
                        value: false
                    }, locationHistory: {
                        type: Array,
                        notify: true,
                        value: []
                    }, userStatus: {
                        type: String,
                        notify: true,
                        value: "N/A"
                    }, rootPattern: String,
                    routeData: Object,
                    subroute: String,
                };
            }
            static get observers() { return ['_routePageChanged(routeData.page)', ]; }
            ready() {
                super.ready();
                this.addEventListener('geo-response', e => this._handleNewData(e));
                this.$.auth.signInAnonymously();
            }
            _showPage404() { this.page = '404'; }
            constructor() {
                super();
                // Get root pattern for app-route, for more info about `rootPath` see:
                // https://www.polymer-project.org/2.0/docs/upgrade#urls-in-templates
                this.rootPattern = (new URL(this.rootPath)).pathname;
            }
            _routePageChanged(page) {
                // Polymer 2.0 will call with `undefined` on initialization.
                // Ignore until we are properly called with a string.
                if (page === undefined)
                    return;
                // If no page was found in the route data, page will be an empty string.
                // Deault to 'home' in that case.
                this.page = page || 'home';
                // Close a non-persistent drawer when the page & route are changed.
                if (!this.$.drawer.persistent)
                    this.$.drawer.close();
            }
            _pageChanged(page) {
                // Load page import on demand. Show 404 page if fails
                var resolvedPageUrl = this.resolveUrl('gg-' + page + '.html');
                Polymer.importHref(resolvedPageUrl, null, this._showPage404.bind(this), true);
            }
            _handleNewData(e) {
                if(this.lat === null || this.lat === undefined || this.lng === null || this.lng === undefined || this.increment === null || this.increment === undefined) return;
                log("==========================USER STATUS MONITORING==========================");
                log("this.lat");
                log(this.lat);
                log("this.lng");
                log(this.lng);
                log("this.idleTime");
                log(this.idleTime);
                log("this.increment");
                log(this.increment);
                this.set("sectorId", this.getIDFromCoords(this.lat, this.lng, this.increment));
                if(e !== undefined && e !== null && !!e.type) {
                    console.log("location");
                    console.log(e);
                    this.set("sectorId", this.getIDFromCoords(e.detail.position.coords.latitude, e.detail.position.coords.longitude, this.increment));
                    var lh = this.locationHistory;
                    lh.push({"lat": e.detail.position.coords.latitude, "lon": e.detail.position.coords.longitude, "time": Math.round(e.detail.position.timestamp/1000)});
                    this.set("locationHistory", lh);
                }
                this.set("userStatus", this.checkIdle(this.increment, this.idleTime)? "Idle" : "N/A");
                console.log(this.locationHistory);
                log("~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~");
            }
            getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
                var p = 0.017453292519943295;
                return 12742 * Math.asin(Math.sqrt(0.5 - Math.cos((lat2 - lat1) * p) / 2 + Math.cos(lat1 * p) * Math.cos(lat2 * p) * (1 - Math.cos((lon2 - lon1) * p)) / 2));
            }
            getIDFromCoords(lat, lon, inc) {
                return (Math.ceil(lat * Math.round(1/inc)) * inc).toFixed((Math.round(1/inc) + "").length - 1) + "|" + (Math.floor(lon * Math.round(1/inc)) * inc).toFixed((Math.round(1/inc) + "").length - 1) + "|" + (Math.floor(lat * Math.round(1/inc)) * inc).toFixed((Math.round(1/inc) + "").length - 1) + "|" + (Math.ceil(lon * Math.round(1/inc)) * inc).toFixed((Math.round(1/inc) + "").length - 1);
            }
            checkIdle(increment, idleTime) {
                var lh = this.locationHistory;
                if(lh.length == 0) return;
                while(lh.length > 1 && (lh.slice(-1)[0].time - lh[0].time) >= (idleTime+60)) lh.shift();
                this.set("locationHistory", lh);
                console.log(this.getDistanceFromLatLonInKm(lh[0].lat, lh[0].lon, lh.slice(-1)[0].lat, lh.slice(-1)[0].lon));
                return (lh.slice(-1)[0].time - lh[0].time) >= idleTime; // && this.getIDFromCoords(lh[0].lat, lh[0].lon, increment) == this.getIDFromCoords(lh.slice(-1)[0].lat, lh.slice(-1)[0].lon, increment);
            }
            getAdjacentSectors(id, inc) {
                var ids = [id];
                var partsArray = id.split('|');
                var decs = (Math.round(1/inc) + "").length - 1;
                for(i=0; i < partsArray.length; i++) partsArray[i] = parseFloat(partsArray[i]);
                    ids.push(partsArray[0]+"|"+(partsArray[1]-inc).toFixed(decs)+"|"+partsArray[2]+"|"+(partsArray[3]-inc).toFixed(decs));
                    ids.push((partsArray[0]-inc).toFixed(decs)+"|"+(partsArray[1]-inc).toFixed(decs)+"|"+(partsArray[2]-inc).toFixed(decs)+"|"+(partsArray[3]-inc).toFixed(decs));
                    ids.push((partsArray[0]-inc).toFixed(decs)+"|"+partsArray[1]+"|"+(partsArray[2]-inc).toFixed(decs)+"|"+partsArray[3]);
                    ids.push((partsArray[0]-inc).toFixed(decs)+"|"+(partsArray[1]+inc).toFixed(decs)+"|"+(partsArray[2]-inc).toFixed(decs)+"|"+(partsArray[3]+inc).toFixed(decs));
                    ids.push(partsArray[0]+"|"+(partsArray[1]+inc).toFixed(decs)+"|"+partsArray[2]+"|"+(partsArray[3]+inc).toFixed(decs));
                    ids.push((partsArray[0]+inc).toFixed(decs)+"|"+(partsArray[1]+inc).toFixed(decs)+"|"+(partsArray[2]+inc).toFixed(decs)+"|"+(partsArray[3]+inc).toFixed(decs));
                    ids.push((partsArray[0]+inc).toFixed(decs)+"|"+partsArray[1]+"|"+(partsArray[2]+inc).toFixed(decs)+"|"+partsArray[3]);
                    ids.push((partsArray[0]+inc).toFixed(decs)+"|"+(partsArray[1]-inc).toFixed(decs)+"|"+(partsArray[2]+inc).toFixed(decs)+"|"+(partsArray[3]-inc).toFixed(decs));
                    return ids;
            }
            parseJson() {
                var items = [].slice.apply(arguments);
                return items.reduce(function (acc, item) { return acc + "\nObject\n" + JSON.stringify(item, null, 4); }, "");
            }
        }
        var debug = true; function log(message) {if (debug) console.log(message);}
        window.customElements.define(GGApp.is, GGApp);
    </script>
</dom-module>